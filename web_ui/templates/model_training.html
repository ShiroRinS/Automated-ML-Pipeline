{% extends "base.html" %}

{% block title %}Model Training{% endblock %}

{% block head %}
<!-- Include marked.js for markdown parsing -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<!-- Include Bootstrap tooltips -->
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js"></script>
<!-- Include custom suggestions script -->
<script src="{{ url_for('static', filename='js/show_suggestions.js') }}"></script>
{% endblock %}

{% block content %}
<div class="container-fluid">
    {% if error %}
    <div class="alert alert-danger" role="alert">
        {{ error }}
    </div>
    {% endif %}
    <!-- Feature Recommendations Section -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Feature Recommendations</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <!-- Gemini Suggestions -->
                    <div class="card h-100">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">Gemini 2.5-flash Suggestions</h6>
                        </div>
                        <div class="card-body">
                            <div id="geminiSpinner" class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="sr-only">Loading suggestions...</span>
                                </div>
                                <p class="mt-2">Getting feature recommendations...</p>
                            </div>
                            <div id="geminiSuggestions" style="display: none;">Loading suggestions...</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <!-- Feature Importance -->
                    <div class="card h-100">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">Feature Importance Analysis</h6>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info mb-3">
                                <h6 class="mb-2"><i class="fas fa-info-circle me-2"></i>Feature Importance Guide</h6>
                                <p class="mb-0" style="font-size: 0.9em;">
                                    Percentages show each feature's relative importance in predicting survival, calculated using Random Forest with Gini impurity reduction.
                                    Higher percentages indicate stronger predictive power.
                                    <br><small class="text-muted mt-1 d-block">Click on a feature's bar to add it to your selection.</small>
                                </p>
                            </div>
                            <div id="featureImportanceChart"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Feature Selection Section -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Feature Selection</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-12">
                    <!-- Selected Features -->
                    <div class="card">
                        <div class="card-header bg-light d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">Selected Features</h6>
                            <span class="badge bg-primary" id="selectedCount">0 selected</span>
                        </div>
                        <div class="card-body">
                            <div id="selectedFeatures" class="d-flex flex-wrap gap-2">
                                <!-- Selected features will be shown here -->
                            </div>
                            <div id="noFeaturesSelected" class="alert alert-warning mt-3" style="display: none;">
                                No features selected. Click on features in the importance chart above to select them for training.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Initial Training Section -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Initial Training</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <!-- Training Parameters -->
                    <div class="form-group">
                        <label for="testSize">Test Size</label>
                        <input type="range" class="form-control-range" id="testSize" min="10" max="40" value="20">
                        <small class="form-text text-muted">Test set size: <span id="testSizeValue">20</span>%</small>
                    </div>
                    <button class="btn btn-primary" id="trainButton">Train Model</button>
                </div>
                <div class="col-md-8">
                    <!-- Training Results -->
                    <div id="trainingResults" style="display: none;">
                        <h6>Training Results</h6>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="info-box">
                                    <h6>Training Score</h6>
                                    <p id="trainScore">-</p>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="info-box">
                                    <h6>Test Score</h6>
                                    <p id="testScore">-</p>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="info-box">
                                    <h6>CV Score</h6>
                                    <p id="cvScore">-</p>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="info-box">
                                    <h6>Feature Count</h6>
                                    <p id="featureCount">-</p>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <!-- Classification Report -->
                                <div class="card">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">Classification Report</h6>
                                    </div>
                                    <div class="card-body">
                                        <div id="classificationReport"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <!-- Confusion Matrix -->
                                <div class="card">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">Confusion Matrix</h6>
                                    </div>
                                    <div class="card-body">
                                        <div id="confusionMatrix"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Model Tuning Section -->
    <div class="card mb-4" id="tuningSection" style="display: none;">
        <div class="card-header">
            <h5 class="mb-0">Model Tuning</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <!-- Hyperparameter Settings -->
                    <div class="card">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">Hyperparameters</h6>
                        </div>
                        <div class="card-body">
                            <form id="hyperparametersForm">
                                <!-- Parameters will be added here -->
                            </form>
                            <button class="btn btn-primary mt-3" id="tuneButton">Tune Model</button>
                        </div>
                    </div>
                </div>
                <div class="col-md-8">
                    <!-- Tuning Results -->
                    <div id="tuningResults" style="display: none;">
                        <h6>Tuning Results</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <!-- Best Parameters -->
                                <div class="card">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">Best Parameters</h6>
                                    </div>
                                    <div class="card-body">
                                        <div id="bestParams"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <!-- Performance Improvement -->
                                <div class="card">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">Performance Improvement</h6>
                                    </div>
                                    <div class="card-body">
                                        <div id="performanceImprovement"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="row mt-4">
        <div class="col-12">
            <button class="btn btn-secondary" id="backButton">Back to Data Cleaning</button>
            <button class="btn btn-success" id="saveModelButton" style="display: none;">Save Model</button>
        </div>
    </div>
</div>

<!-- Custom Styles -->
<style>
.info-box {
    padding: 15px;
    border: 1px solid #ddd;
    border-radius: 5px;
    text-align: center;
}
.info-box h6 {
    margin-bottom: 5px;
    color: #666;
}
.info-box p {
    font-size: 1.2em;
    margin: 0;
    font-weight: bold;
}
.feature-item {
    cursor: pointer;
    user-select: none;
    transition: all 0.2s ease;
}
.feature-item:hover {
    background-color: #f8f9fa;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}
.feature-item.selected {
    background-color: #e7f0ff;
    border-left: 3px solid #0d6efd;
}

/* Markdown Content Styling */
.markdown-content {
    font-size: 0.95em;
    line-height: 1.6;
}

.markdown-content h3 {
    color: #0d6efd;
    font-size: 1.2em;
    margin-top: 1.5em;
    margin-bottom: 1em;
    padding-bottom: 0.5em;
    border-bottom: 1px solid #e9ecef;
    display: flex;
    align-items: center;
    gap: 0.5em;
}

.markdown-content h3:first-child {
    margin-top: 0;
}

.markdown-content ul {
    list-style: none;
    padding-left: 1.2em;
    margin-bottom: 1.5em;
}

.markdown-content li {
    margin-bottom: 0.8em;
    position: relative;
}

.markdown-content li::before {
    content: '•';
    color: #0d6efd;
    font-weight: bold;
    position: absolute;
    left: -1.2em;
}

.markdown-content strong {
    color: #0d6efd;
    font-weight: 600;
}

.markdown-content p {
    margin-bottom: 1em;
}

.markdown-content code {
    background-color: #f8f9fa;
    padding: 0.2em 0.4em;
    border-radius: 3px;
    color: #d63384;
    font-family: SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    font-size: 0.875em;
}
</style>

<!-- Custom Scripts -->
<script>
// Initialize recommendations data
var initial_recommendations = {% if initial_recommendations %}{{ initial_recommendations|tojson|safe }}{% else %}null{% endif %};

// Dynamic feature descriptions
let descriptions = {};

// Debug output
console.log('Initial recommendations:', initial_recommendations);
if (initial_recommendations && initial_recommendations.feature_importances) {
    console.log('Feature importances:', initial_recommendations.feature_importances);
}
$(document).ready(function() {
    {% if data_loaded %}
        {% if initial_recommendations %}
        console.log('Processing initial recommendations');
        if (initial_recommendations.raw_suggestions) {
            showGeminiSuggestions(initial_recommendations.raw_suggestions);
        } else {
            $('#geminiSuggestions').html('<div class="alert alert-warning">No feature recommendations available.</div>').show();
        }
        
        // Show feature importance
        if (initial_recommendations.feature_importances && initial_recommendations.feature_importances.length > 0) {
            console.log('Displaying feature importance for:', initial_recommendations.feature_importances);
showFeatureImportance(initial_recommendations.feature_importances);
initTooltips();
            
            // Also populate available features from importance scores
            loadFeaturesFromImportance(initial_recommendations.feature_importances);
        } else {
            console.log('No feature importance data available');
            $('#featureImportanceChart').html('<div class="alert alert-warning">No feature importance data available. Please ensure the model has been trained.</div>');
        }
        {% else %}
        // Load feature recommendations
        loadFeatureRecommendations();
        {% endif %}
    {% else %}
        $('#geminiSuggestions').html('<div class="alert alert-warning">Please load data first</div>');
        $('#featureSpinner').hide();
        $('#availableFeatures').html('<div class="alert alert-warning">No data loaded</div>').show();
    {% endif %}
    
// Feature selection handling
    $(document).on('click', '.feature-item', function(e) {
        // Toggle selection
        $(this).toggleClass('selected');
        updateSelectedFeatures();
    });
    
    // Initialize selected features count
    updateSelectedFeatures();
    
    // Test size slider
    $('#testSize').on('input', function() {
        $('#testSizeValue').text($(this).val());
    });
    
    // Train button
    $('#trainButton').click(function() {
        trainModel();
    });
    
    // Tune button
    $('#tuneButton').click(function() {
        tuneModel();
    });
    
    // Save model button
    $('#saveModelButton').click(function() {
        saveModel();
    });
    
    // Back button
    $('#backButton').click(function() {
        window.location.href = '/clean-data';
    });
});

function showGeminiSuggestions(suggestions) {
    $('#geminiSpinner').hide();
    if (typeof suggestions === 'string' && suggestions.startsWith('Error')) {
        const errorMsg = suggestions.includes('Missing required section') ?
            'The feature recommendations system is temporarily unavailable. Please proceed with the feature importance scores below.' :
            suggestions;
        $('#geminiSuggestions').html('<div class="alert alert-warning">' + errorMsg + '</div>').show();
    } else {
        try {
            // Parse markdown to HTML
            const htmlContent = marked.parse(suggestions);
            $('#geminiSuggestions').html(`
                <div class="alert alert-info markdown-content">
                    ${htmlContent}
                </div>
            `).show();
        } catch (e) {
            console.error('Error parsing markdown:', e);
            $('#geminiSuggestions').html('<div class="alert alert-warning">Error displaying recommendations. Please use the feature importance scores below.</div>').show();
        }
    }
}

function loadFeatureRecommendations() {
    $.get('/api/feature-recommendations', function(response) {
        if (response.success) {
            // Show Gemini suggestions
            showGeminiSuggestions(response.raw_suggestions);
            
            // Show feature importance
            showFeatureImportance(response.feature_importances);
            
            // Load available features
            loadFeatures(response.features);
        } else {
            alert('Error loading recommendations: ' + response.error);
        }
    });
}

function showFeatureImportance(importances) {
    $('#featureSpinner').hide();
    var html = '<div class="list-group">';
    
    // Sort features by importance
    importances.sort((a, b) => b.importance - a.importance);
    
    // Display features with importance scores
    importances.forEach(function(item) {
        var importance = (item.importance * 100).toFixed(2);
        html += `
            <div class="list-group-item feature-item" data-feature="${item.feature}" data-importance="${item.importance}" data-bs-toggle="tooltip" data-bs-placement="right" title="${descriptions[item.feature]?.full || 'No detailed description available'}">
                <div class="d-flex w-100 justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-1">${item.feature}</h6>
                        <small class="text-muted">Predictive Power: ${importance}%</small>
                    </div>
                    <span class="badge bg-primary">#${importances.indexOf(item) + 1}</span>
                </div>
                <div class="progress mt-2" style="height: 8px;">
                    <div class="progress-bar bg-primary" role="progressbar" 
                         style="width: ${importance}%" 
                         title="${importance}% importance">
                    </div>
                </div>
            </div>`;
    });
    
    html += '</div>';
    $('#featureImportanceChart').html(html).show();
    
    // Initialize tooltips after adding elements to DOM
    initTooltips();
}

function loadFeatures(features) {
    // Generate feature descriptions first
    generateFeatureDescriptions(features);
    var html = '';
    features.forEach(function(feature) {
html += `
            <div class="list-group-item feature-item" data-feature="${feature.name}" data-importance="${feature.importance || 0}">
                <div class="d-flex w-100 justify-content-between">
                    <h6 class="mb-1">${feature.name}</h6>
                    <small>${feature.importance ? feature.importance.toFixed(4) : ''}</small>
                </div>
                <small class="text-muted">${feature.type || 'No description available'}</small>
            </div>
        `;
    });
    if (html === '') {
        html = 'div class="alert alert-info"No available features to display./div';
    }
    $('#featureSpinner').hide();
    $('#availableFeatures').html(html).show();
}

function initTooltips() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.forEach(function (tooltipTriggerEl) {
        new bootstrap.Tooltip(tooltipTriggerEl, {
            html: true,
            template: '<div class="tooltip" role="tooltip"><div class="tooltip-arrow"></div><div class="tooltip-inner text-start" style="max-width: 300px;"></div></div>'
        });
    });
}

function generateFeatureDescriptions(features) {
    // Automatically generate descriptions based on feature properties
    features.forEach(feature => {
        const name = feature.name;
        const sampleValues = feature.sample_values || [];
        const type = feature.type || 'unknown';
        const missingPct = feature.missing_pct || 0;
        
        let shortDesc = `${name} (${type})`;
        let fullDesc = `${name}: ${type} feature. `;
        
        // Add information about missing values
        if (missingPct > 0) {
            fullDesc += `Contains ${missingPct.toFixed(1)}% missing values. `;
        }
        
        // Add sample values if available
        if (sampleValues.length > 0) {
            fullDesc += `Example values: ${sampleValues.slice(0, 3).join(', ')}. `;
        }
        
        descriptions[name] = {
            short: shortDesc,
            full: fullDesc
        };
    });
}

function loadFeaturesFromImportance(importances) {

    var features = importances.map(item => ({
        name: item.feature,
        importance: item.importance,
        type: descriptions[item.feature]?.short || 'No description available'
    }));

    loadFeatures(features);
}

function updateSelectedFeatures() {
    var selected = [];
    $('.feature-item.selected').each(function() {
        selected.push({
            name: $(this).data('feature'),
            importance: parseFloat($(this).data('importance'))
        });
    });
    
    // Sort by importance
    selected.sort((a, b) => b.importance - a.importance);
    
    // Update UI
    updateSelectedFeaturesList(selected);
    $('#selectedCount').text(`${selected.length} selected`);
    
    // Show/hide no features message
    if (selected.length === 0) {
        $('#noFeaturesSelected').show();
    } else {
        $('#noFeaturesSelected').hide();
    }
}

function updateSelectedFeaturesList(features) {
    var html = '';
    features.forEach(function(feature) {
        const importance = (feature.importance * 100).toFixed(2);
        html += `
            <div class="badge bg-primary p-2 d-flex align-items-center">
                <span>${feature.name}</span>
                <small class="ms-2 opacity-75">${importance}%</small>
                <button type="button" class="btn-close btn-close-white ms-2" 
                    data-feature="${feature.name}" 
                    onclick="deselectFeature('${feature.name}')"></button>
            </div>
        `;
    });
    $('#selectedFeatures').html(html || '');
}

function deselectFeature(featureName) {
    $(`.list-group-item:contains('${featureName}')`).removeClass('selected');
    updateSelectedFeatures();
}

function trainModel() {
    var selectedFeatures = $('.list-group-item.selected h6').map(function() {
        return $(this).text();
    }).get();
    
    var testSize = $('#testSize').val() / 100;
    
    $.ajax({
        url: '/api/train-model',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            features: selectedFeatures,
            test_size: testSize
        }),
        success: function(response) {
            if (response.success) {
                showTrainingResults(response.results);
                $('#tuningSection').show();
                $('#saveModelButton').show();
            } else {
                alert('Error training model: ' + response.error);
            }
        },
        error: function() {
            alert('Error training model');
        }
    });
}

function showTrainingResults(results) {
    $('#trainingResults').show();
    
    // Display metrics
    if (results.metrics) {
        $('#trainScore').text((results.metrics.train_score * 100).toFixed(2) + '%');
        $('#testScore').text((results.metrics.test_score * 100).toFixed(2) + '%');
        $('#cvScore').text((results.metrics.cv_mean * 100).toFixed(2) + '%');
        $('#featureCount').text(results.feature_importance.length);
        
        // Show classification report
        showClassificationReport(results.metrics.classification_report);
        
        // Show confusion matrix
        showConfusionMatrix(results.metrics.confusion_matrix);
    } else {
        console.error('Missing metrics in training results');
        alert('Warning: Training completed but metrics are missing');
    }
}

function showClassificationReport(report) {
    if (!report) return;
    
    var html = '<table class="table table-sm table-bordered">';
    html += '<thead><tr><th>Class</th><th>Precision</th><th>Recall</th><th>F1-score</th><th>Support</th></tr></thead>';
    html += '<tbody>';
    
    // Add per-class metrics
    for (let cls in report) {
        if (cls !== 'accuracy' && cls !== 'macro avg' && cls !== 'weighted avg') {
            html += `<tr>
                <td>${cls}</td>
                <td>${(report[cls].precision * 100).toFixed(2)}%</td>
                <td>${(report[cls].recall * 100).toFixed(2)}%</td>
                <td>${(report[cls].f1_score * 100).toFixed(2)}%</td>
                <td>${report[cls].support}</td>
            </tr>`;
        }
    }
    
    // Add accuracy
    if (report.accuracy) {
        html += `<tr class="table-info">
            <td colspan="3"><strong>Accuracy</strong></td>
            <td colspan="2">${(report.accuracy * 100).toFixed(2)}%</td>
        </tr>`;
    }
    
    html += '</tbody></table>';
    $('#classificationReport').html(html);
}

function showConfusionMatrix(matrix) {
    if (!matrix || !Array.isArray(matrix)) return;
    
    const total = matrix.reduce((sum, row) => sum + row.reduce((a, b) => a + b, 0), 0);
    
    var html = '<table class="table table-sm table-bordered text-center">';
    html += '<thead><tr><th colspan="2" rowspan="2"></th><th colspan="2">Predicted</th></tr>';
    html += '<tr><th>Negative</th><th>Positive</th></tr></thead>';
    html += '<tbody>';
    
    // Add actual values rows
    for (let i = 0; i < matrix.length; i++) {
        html += '<tr>';
        if (i === 0) {
            html += '<th rowspan="2">Actual</th><th>Negative</th>';
        } else {
            html += '<th>Positive</th>';
        }
        
        for (let j = 0; j < matrix[i].length; j++) {
            const percentage = (matrix[i][j] / total * 100).toFixed(1);
            const bgClass = i === j ? 'table-success' : 'table-danger';
            html += `<td class="${bgClass}">${matrix[i][j]}<br><small>(${percentage}%)</small></td>`;
        }
        html += '</tr>';
    }
    
    html += '</tbody></table>';
    $('#confusionMatrix').html(html);
}

function tuneModel() {
    var params = {};
    $('#hyperparametersForm input').each(function() {
        params[$(this).attr('name')] = $(this).val();
    });
    
    $.ajax({
        url: '/api/tune-model',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(params),
        success: function(response) {
            if (response.success) {
                showTuningResults(response.results);
            } else {
                alert('Error tuning model: ' + response.error);
            }
        },
        error: function() {
            alert('Error tuning model');
        }
    });
}

function showTuningResults(results) {
    $('#tuningResults').show();
    
    // Show best parameters
    var paramsHtml = '<ul class="list-unstyled">';
    Object.entries(results.best_params).forEach(([param, value]) => {
        paramsHtml += `<li><strong>${param}:</strong> ${value}</li>`;
    });
    paramsHtml += '</ul>';
    $('#bestParams').html(paramsHtml);
    
    // Show performance improvement
    var improvementHtml = `
        <div class="text-center">
            <h3>${(results.improvement * 100).toFixed(2)}%</h3>
            <p>Performance Improvement</p>
        </div>
    `;
    $('#performanceImprovement').html(improvementHtml);
}

function saveModel() {
    $.post('/api/save-model', function(response) {
        if (response.success) {
            alert('Model saved successfully!');
            window.location.href = '/models';
        } else {
            alert('Error saving model: ' + response.error);
        }
    });
}
</script>
{% endblock %}
